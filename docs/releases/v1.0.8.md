# Claw-Empire v1.0.8 Release Notes

- Release date: 2026-02-20
- Scope: Active-agent observability and kill controls, task completion reporting/archiving, long-run stability improvements for CLI/OAuth/API execution, and communication QA test suite scripts.

## Highlights

- **Active Agents Status + Kill Control**
  - Added `AgentStatusPanel` UI to monitor currently working agents with process/session metadata.
  - Added hard-stop action from UI (`Kill`) backed by existing stop endpoint.
  - New API: `GET /api/agents/active` for active worker snapshot (`has_active_process`, `last_activity_at`, `idle_seconds`).
- **Task Completion Reports + Planning Consolidation Archive**
  - Added automatic `task_report` WebSocket broadcast when task review is finalized.
  - Added report popup and report-history modal in frontend (`TaskReportPopup`, `ReportHistory`).
  - Added planning-lead consolidated markdown archive generation using model one-shot + fallback synthesis.
  - Added archive refresh trigger from report popup.
  - New DB table: `task_report_archives` (`root_task_id` unique, summary markdown + source snapshot).
  - New APIs:
    - `GET /api/task-reports`
    - `GET /api/task-reports/:taskId`
    - `POST /api/task-reports/:taskId/archive`
- **Long-Run Stability for CLI/OAuth/API Task Execution**
  - Increased default idle timeout from 8m to 15m (`TASK_RUN_IDLE_TIMEOUT_MS`).
  - Disabled hard timeout by default (`TASK_RUN_HARD_TIMEOUT_MS=0` default).
  - Increased default orphan grace window to 10m (`IN_PROGRESS_ORPHAN_GRACE_MS`).
  - Added extra orphan-recovery safety: skip recovery if recent task logs exist (last 2 minutes).
  - Added stale-process cleanup on re-run and stale `in_progress` state reset when no live process exists.
  - Added Codex run arg `--max-turns 200` to reduce premature round termination in complex tasks/tests.
- **Connectivity QA Scripts (CLI/OAuth/API)**
  - Added QA connectivity suite scripts and unified entrypoint:
    - `pnpm run test:comm:llm`
    - `pnpm run test:comm:oauth`
    - `pnpm run test:comm:api`
    - `pnpm run test:comm:suite`
    - `pnpm run test:comm-status` (legacy-compatible entry)
  - Added structured evidence output (`logs/*.json`) and markdown report artifacts (`docs/qa-connectivity-*-report.md`).
- **Model List Hygiene**
  - Added duplicate filtering when merging OAuth model lists from provider API and OpenCode fallback.
  - Prevented duplicate option-key issues in Settings model select lists.

## Problem-Cause Alignment

1. **Tasks ended before meaningful completion during test-heavy work**  
   Root causes included restrictive run limits/timeouts and stale in-progress state handling.  
   Fixed with `--max-turns 200`, longer idle window, no default hard timeout, stale-state cleanup, and safer orphan recovery.
2. **No direct visibility into which agents are actually active (and killable)**  
   Added active-agent status endpoint plus frontend panel with idle/activity/process indicators and stop action.
3. **Missing structured end-of-task reporting for final decision-making**  
   Added task-report detail/history pipeline and planning-lead consolidated archive generation + refresh.

## Changed Files (Major)

### Backend
- `server/modules/routes/core.ts` — active agent status route, stale process cleanup, stale in-progress reset on re-run
- `server/modules/routes/ops.ts` — task-report APIs + archive trigger, OAuth model dedupe
- `server/modules/lifecycle.ts` — orphan recovery safety check for recent task logs
- `server/modules/workflow/core.ts` — timeout defaults, Codex max-turns argument
- `server/modules/workflow/orchestration.ts` — task-report broadcast + planning consolidated archive generation
- `server/db/runtime.ts` — orphan grace default increase
- `server/server-main.ts` — `task_report_archives` table/index
- `server/modules/workflow.ts` — runtime context propagation for archive function

### Frontend
- `src/App.tsx` — report popup/history/agent-status panel integration
- `src/api.ts` — active-agent + task-report APIs and types
- `src/types/index.ts` — `task_report` WS event type
- `src/components/AgentStatusPanel.tsx` — active workers modal with kill control
- `src/components/ReportHistory.tsx` — grouped report history modal
- `src/components/TaskReportPopup.tsx` — consolidated report viewer + archive refresh
- `src/components/SettingsPanel.tsx` — model option-key hardening

### QA / Scripts
- `scripts/qa/connectivity-lib.mjs`
- `scripts/qa/llm-comm-test.mjs`
- `scripts/qa/oauth-comm-test.mjs`
- `scripts/qa/api-comm-test.mjs`
- `scripts/qa/run-comm-suite.mjs`
- `scripts/test-comm-status.mjs`
- `package.json` — added `test:comm:*` scripts

## New API Routes

| Method | Route | Description |
| --- | --- | --- |
| GET | `/api/agents/active` | Returns currently working agents with task/process/session activity data |
| GET | `/api/task-reports` | Lists recently completed root-task reports |
| GET | `/api/task-reports/:taskId` | Returns root-task report detail with planning summary, team reports, docs/logs/minutes |
| POST | `/api/task-reports/:taskId/archive` | Regenerates and archives planning consolidated markdown summary |

## New DB Table

```sql
CREATE TABLE IF NOT EXISTS task_report_archives (
  id TEXT PRIMARY KEY,
  root_task_id TEXT NOT NULL UNIQUE REFERENCES tasks(id) ON DELETE CASCADE,
  generated_by_agent_id TEXT REFERENCES agents(id),
  summary_markdown TEXT NOT NULL,
  source_snapshot_json TEXT,
  created_at INTEGER DEFAULT (unixepoch()*1000),
  updated_at INTEGER DEFAULT (unixepoch()*1000)
);
```

## Maintenance Notes

- Long-running workflow behavior is now intentionally biased toward completion (`idle=15m`, default hard timeout disabled). If needed, re-tighten via env vars.
- `task_report_archives` is keyed by `root_task_id` and uses upsert semantics for the latest planning consolidation.
- Report detail response may include file snapshots extracted from task descriptions/results/logs; very large text is clipped for safety.
