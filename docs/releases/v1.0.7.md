# Claw-Empire v1.0.7 Release Notes

- Release date: 2026-02-20
- Scope: External API provider system (Settings API tab), direct chat streaming for API/OAuth agents, task execution crash fix, model caching layer.

## Highlights

- **External API Provider System**: Settings 패널에 API 탭 추가. OpenAI, Anthropic, Google, Ollama, OpenRouter, Together, Groq, Cerebras 등 외부 LLM API를 통해 에이전트를 구동할 수 있음.
  - Provider CRUD (추가/수정/삭제), 연결 테스트, 모델 자동 감지
  - 에이전트별 API provider + model 할당 UI
  - API key는 서버 측 `encryptApiKey`/`decryptApiKey`로 암호화 저장
  - `api_providers` SQLite 테이블 신규 생성
- **Direct Chat Streaming**: API/OAuth 에이전트의 다이렉트 채팅 응답이 실시간 스트리밍으로 표시됨.
  - `chat_stream` WebSocket 이벤트 (start → delta → end 3-phase)
  - ChatPanel에 에메랄드 보더 + 깜빡이는 커서 애니메이션
  - 스트리밍 중 메시지가 점진적으로 렌더링됨
- **API Provider Task Execution**: API provider를 사용하는 에이전트가 task 실행(spawn, run)도 지원.
  - `launchApiProviderAgent`: logStream 생성, mock ChildProcess, `cli_output` WS 브로드캐스트
  - Provider 타입별 SSE 파서 분기 (Anthropic / Google / OpenAI-compatible)
  - orchestration 경로와 direct endpoint 경로 모두 지원
- **Task Execution Crash Fix**: `orchestration.ts`에서 `const httpAgentCounter`를 `++`로 증가시키는 런타임 크래시 수정.
  - `const` → `let` 변경으로 OAuth/API 에이전트의 task 실행 시 500 에러 해결
- **Model Caching Layer**: CLI/OAuth 모델 목록에 SQLite + 메모리 2-tier 캐시 적용.
  - `settings` 테이블에 `cli_models_cache`, `oauth_models_cache` 키로 영속 캐싱
  - 메모리 캐시 → DB 캐시 → 원격 fetch 순서로 조회

## Problem-Cause Alignment

1. **`TypeError: Assignment to constant variable`** — `orchestration.ts`에서 `httpAgentCounter`가 `const`로 선언되었으나 `++httpAgentCounter`로 mutation 시도. JavaScript에서 primitive 값은 복사되므로 `__ctx.httpAgentCounter`를 복사받은 지역 변수는 `let`이어야 함.
2. **API 에이전트 Parrot Response** — API provider를 통한 다이렉트 채팅 시 실제 LLM 응답 대신 입력을 그대로 반복하는 문제. 스트리밍 경로 추가 및 `chooseSafeReply` 언어 필터 우회로 해결.
3. **모델 목록 로딩 지연** — 매 요청마다 원격 API를 호출하여 모델 목록을 가져오는 비효율. 2-tier 캐시(메모리 + SQLite)로 해결.

## Changed Files

### Server
- `server/modules/workflow/orchestration.ts` — `const` → `let` crash fix, API provider branch 추가
- `server/modules/workflow/agents/providers.ts` — `executeApiProviderAgent`, `launchApiProviderAgent`, Anthropic/Google SSE 파서, API provider 헬퍼 함수들
- `server/modules/workflow/agents.ts` — Context chain에 `executeApiProviderAgent`, `launchApiProviderAgent` 추가
- `server/modules/workflow/core.ts` — `runAgentOneShot` API provider branch, OAuth `rawOutput` 누적 fix
- `server/modules/routes/ops.ts` — API Provider CRUD endpoints, model caching (`readModelCache`/`writeModelCache`)
- `server/modules/routes/core.ts` — `launchApiProviderAgent` import, agent spawn/run에 API provider branch 추가
- `server/modules/routes/collab.ts` — Direct chat streaming (API/OAuth), `chat_stream` WS event
- `server/server-main.ts` — `api_providers` 테이블 생성, agents 테이블 CHECK constraint migration (`'api'` 추가)

### Frontend
- `src/App.tsx` — `streamingMessage` state, `chat_stream` WebSocket handler
- `src/components/ChatPanel.tsx` — StreamingMessage 렌더링 (에메랄드 보더 + 커서 애니메이션)
- `src/components/SettingsPanel.tsx` — API Providers 탭 전체 UI (CRUD, 연결 테스트, 모델 선택)
- `src/components/AgentDetail.tsx` — API provider/model 표시 간소화
- `src/api.ts` — API Provider CRUD API 함수들
- `src/types/index.ts` — `chat_stream` WSEventType, `ApiProvider`/`ApiProviderType` 타입

## New API Routes

| Method | Route | Description |
| --- | --- | --- |
| GET | `/api/api-providers` | 전체 API provider 목록 조회 |
| POST | `/api/api-providers` | API provider 추가 |
| PUT | `/api/api-providers/:id` | API provider 수정 |
| DELETE | `/api/api-providers/:id` | API provider 삭제 |
| POST | `/api/api-providers/:id/test` | 연결 테스트 + 모델 캐싱 |
| GET | `/api/api-providers/:id/models` | provider 모델 목록 조회 |
| GET | `/api/api-providers/presets` | Provider 타입별 프리셋 |

## New DB Table

```sql
CREATE TABLE IF NOT EXISTS api_providers (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  type TEXT NOT NULL CHECK(type IN ('openai','anthropic','google','ollama','openrouter','together','groq','cerebras','custom')),
  base_url TEXT NOT NULL,
  api_key_enc TEXT,
  enabled INTEGER DEFAULT 1,
  models_cache TEXT,
  models_cached_at TEXT
)
```

## New WebSocket Event

| Event | Direction | Payload |
| --- | --- | --- |
| `chat_stream` | Server → Client | `{ agentId, phase: "start"/"delta"/"end", content?, messageId? }` |

## Maintenance Notes

- `httpAgentCounter`는 `__ctx`에서 primitive로 복사되므로, mutation이 필요한 모듈에서는 반드시 `let`으로 선언해야 함. 현재 `core.ts`와 `orchestration.ts` 두 곳에서만 사용.
- API provider의 API key는 `encryptApiKey`로 암호화되어 `api_key_enc` 컬럼에 저장됨. 복호화는 `decryptApiKey`로 수행.
- `chat_stream` 스트리밍은 `chooseSafeReply` 언어 필터를 우회함 — 스트리밍 중간에 필터링하면 UX가 깨지기 때문.
- agents 테이블의 `cli_provider` CHECK constraint에 `'api'`가 추가됨. migration은 `DROP TABLE + RENAME` 방식으로 수행되며 `hasApiCheck` 조건으로 중복 실행 방지.
